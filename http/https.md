# 理解HTTPS流程

HTTPS (HTTP Secure) 并不是新协议，而是 HTTP 先和 SSL（Secure Sockets Layer 安全套接层）/ TLS (Transport Layer Security 安全层传输协议) 通信，再由 SSL/TLS 和 TCP 通信。也就是说 HTTPS 使用了隧道进行通信。

在 HTTPS 的通信过程中，涉及了大量 TLS握手、CA、数字证书、对称/非对称加密等信息，所以，在本文我们了解 HTTPS 的流程，有助于 应用层网络、kubernetes 的工作中，更能得心应手。

首先，HTTPS 的本质是解决信息传递的安全性。对于一个是 1 v 1的服务模型而言，使用对称加密就可以，只要保证密钥的安全，不让第三者知道，信息传输安全的问题就解决！

<div  align="center">
	<img src="../assets/https-1.png" width = "450"  align=center />
</div>

### HTTP 1vN 的问题

使用对称加密的方式，在 HTTP 服务模式就有问题了，HTTP的服务模型是 1 v N, 使用对称加密的核心是如何保证秘钥的安全性，在 1 v N 的模型下，这种方式等同没有加密。 

<div  align="center">
	<img src="../assets/https-2.png" width = "400"  align=center />
</div>

对于以上问题，我们可以进行改进，每个客户端使用不同的算法，并在中间增加一个协商的过程，用于双方协商对称加密算法。

<div  align="center">
	<img src="../assets/https-3.png" width = "400"  align=center />
</div>

使用协商过程可以解决 1 v N 模型固定对称加密算法或秘钥独立性问题，但这又产生新的问题，协商过程是明文的，密钥还是可以被截获，仍然存在不安全性。解决这种问题，只能继续对协商过程的数据进行加密！对协商过程的隐私数据进行加密，就要采取另外一种加密方式了，如果仍然是对称加密，就会产生无限套娃的情况， 这里引入 非对称加密算法！

**非对称加密算法** 它有两个密钥：公钥、私钥。私钥加密的密文只能公钥解，公钥加密的密文只能私钥解。非对称加密大量的乘、模运算效率较低，而对称加密主要是位移类操作，效率较高。而 HTTP 传输信息量一般较大，在保证安全性的前提下，尽可能对内容提升加解密效率，所以在实现上，对内容使用对称加密，而对称加密的密钥则使用非对称加密。

具体则是：在协商流程中，通过随机数确定一个加密算法，然后使用公钥加密算法、密文等，服务器用私钥解密。

### 公钥如何传输给客户端

公钥由服务端下发给客户端，但又出现了上面的问题，如何保证公钥不被中间人截获？

<div  align="center">
	<img src="../assets/https-4.png" width = "400"  align=center />
</div>

### 引入 CA

CA 是 Certificate Authority 的缩写，意为证书认证机构。

如果选择服务端直接给客户端发送公钥证书，无论用什么方式中间被掉包的问题无法解决。用可信任三方的私钥对服务器公钥加密传给客户端。客户端用第三方公钥解密。这样做只要解决第三方的公钥就可以了。

服务端的证书是由 CA 签名，为制作成数字证书。 数字证书一般包括 公钥、持有者信息、证书认证机构（CA）的信息、过期信息...

## 证书验证链

证书的验证过程中还存在一个证书信任链的问题，因为我们向 CA 申请的证书一般不是根证书签发的，而是由中间证书签发。比如 thebyte.com.cn 证书，从下图可以看到，证书的层级有三级：

<div  align="center">
	<img src="../assets/https-5.png" width = "400"  align=center />
</div>

对于这种三级层级关系的证书，会先由本地根证书验证中间证书，如果验证通过，则用中间证书验证 服务器证书，如果验证通过，则表示 服务器证书是可信人的。

从整个流程来看，HTTPS 关键性在于根证书的安全性，在一些地方要求安装根证书，实际上就是变相的中间人。

