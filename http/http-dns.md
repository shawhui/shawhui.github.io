# 使用 HTTP DNS 加速解析

相较于传统的面向浏览器的Web App，C/S架构的应用赋予了我们非常大的软件定制空间，开发者甚至可以渗透到整个应用的底层网络实现当中，域名解析环节的优化因此变为了可能。

## 域名存在的问题

在了解域名解析流程后，我们继续探讨传统域名解析存在的一系列问题：

- **延迟问题** DNS首次查询或缓存过期后的查询，需要递归遍历多个DNS服务器以获取最终的解析结果，这增加了网络请求的前置延时时间。特别是在移动互联网场景下，移动网络质量参差不齐，弱网环境的RTT时间可能高达数百毫秒。

- **域名劫持** 在海外部分地区，存在很严重的域名劫持、污染的问题。这类缓存行为往往是间歇性、局部性发生的，没有明显的规律，导致开发者很难对其进行量化、评估、预防。

- **调度不精准** 部分Local DNS供应商为了降低运营成本，会将域名解析请求转发给其他供应商的Local DNS节点，这类解析转发行为会严重影响域名解析的精准性并对用户业务访问延迟带来影响，特别是CDN的请求访问。


传统域名解析面临的诸多问题与挑战本质根源在于Local DNS的服务质量不可控，如果有一个更安全、稳定、高效的递归 DNS 服务帮助我们代理了域名解析的过程，上述问题看起来就可以彻底地得到解决。HTTPDNS 在这样的背景下应运而生。

## HTTPDNS

HTTPDNS 的原理是原本用户进行 DNS 解析是向运营商的 DNS 服务器发起 UDP 报文进行查询，而在 HTTPDNS 下，修改为用户带上待查询的域名和本机 IP 地址直接向 HTTP 服务器发起 HTTP 请求，这个 HTTP 服务将返回域名解析后的IP地址。

<div  align="center">
	<p>图：HTTP DNS</p>
	<img src="../assets/httpdns.png" width = "520"  align=center />
</div>


### 防劫持

HTTPDNS 代替了传统的LocalDNS完成递归解析的功能，基于HTTP协议的设计可以适用于几乎所有的网络环境，同时保留了鉴权、HTTPS等更高安全性的扩展能力，避免恶意攻击劫持行为。另一方面，商业化的HTTPDNS服务缓存管理有严格的SLA保障，避免了类似Local DNS的缓存污染的问题。

### 精准调度

传统域名解析的调度精准性问题，本质根源在于Local DNS的部署和分配机制上。

由于碎片化的管理方式，这些环节的服务质量同样很难得到保障。HTTPDNS在递归解析实现上优化了与权威DNS的交互，通过edns-client-subnet协议（将终端用户的IP信息直接交付给权威DNS，这样权威DNS就可以忽略Local DNS IP信息，根据终端用户的IP信息进行精准调度，避免Local DNS的坐标干扰。

### DNS预载解析

在DNS解析延迟方面，由于HTTPDNS基于HTTP协议，而HTTP基于TCP协议，对比传统的UDP传输多了一些冗余的握手环节，因此从原理上而言网络请求方面的开销并没有降低。

但在实际使用过程中，我们可以通过端上预解析、懒加载策略来实现一个零延迟 DNS解析的方案。


## HTTPDNS 实践

在 DNS 解析环节，DNS解析的耗时是一个重要的指标，LocalDNS在过期的情况下，会发起递归查询，这个时间是不可控，在部分情况下甚至能达到数秒级别； HTTPDNS 相对会好一些，但正常来看也会有100ms左右的耗时，那么在下面我们将与客户端一起协作，通过HTTPDNS服务，实现包括防止域名劫持、精准调度、实时解析生效等功能。

### 预解析

绝大多数的APP在应用初始化阶段都有一个启动期，我们可以在这个启动期做一些preflight工作，即在初始化阶段我们可以针对业务的热点域名在后台发起异步的HTTPDNS解析请求。这部分预解析结果在后续的业务请求中可以直接使用，进而消除首次业务请求的DNS解析开销，提升APP首页的加载速度。

### 智能缓存

通过预解析获取的IP有一定的TTL有效时间，我们需要合理地缓存下来进行管理。操作系统本身的DNS缓存粒度比较粗，在客户端我们可以应用更细粒度的缓存管理来提升解析效率。比如在不同的网络运营商环境下，对CDN域名的解析结果会发生变化，当我们使用电信WIFI时，DNS解析会返回就近的电信CDN节点IP，当我们使用联通3G时，DNS解析会返回就近的联通CDN节点IP，针对不同运营商的解析结果缓存可以确保我们在网络切换时能够快速地进行网络请求，减免DNS解析带来的额外开销。甚至更激进的，我们可以做本地的持久化缓存，当下一次APP启动时直接读取缓存用于网络访问，以提升首屏加载的速度。

### 懒加载

懒加载策略的实施可以让我们真正实现DNS的零延迟解析。所谓懒加载策略，核心的实现思路如下：

- 业务层的域名解析请求只和缓存进行交互，不实际发生网络解析请求。如果缓存中存在记录，不论过期与否，直接返回业务层缓存中的记录；
- 如果缓存中的记录已过期，后台发起异步网络请求进行HTTPDNS解析

对于懒加载，这里会产生一个疑惑？返回一个过期的IP岂不是违背了TTL设计的初衷？ 的确，上述行为并不符合标准的规范，但是当我们重新审视一下自己的业务特点：绝大多数的业务场景下我们的后端IP是固定的若干个节点，因此连续的解析结果在环境不变的情况下有很大概率是保持一致的，这在一定程度上保证了懒加载的可行性。另一方面，即便我们由于返回过期IP导致了访问异常的行为，后台很快会进行新IP的异步解析和缓存更新，业务本身可以进行重试和快速的复原。再进一步TTL过期的IP的服务在绝大多数场景下还是持续的，可预期的，因此懒加载可能带来的业务风险是可控的。
