# 加速镜像分发：Dragonfly

容器技术虽然通过镜像统一的业务的构建、分发和运行，但是当容器云平台达到一定规模之后，镜像的分发可能成为整个平台的性能瓶颈。 例如:在生产实践中，较大尺寸的容器镜像既影响容器启动，又存在较高的本地存储成本。在应对瞬时高峰，启动几百、几千 Pod 时，受带宽、镜像仓库服务瓶颈等影响，会存在较长的耗时，有时候甚至流量高峰已过，集群还没有扩展完毕。

Dragonfly 则是解决此类问题的方案。

## Dragonfly 介绍

Dragonfly 是阿里巴巴开源的基于 P2P 的镜像和文件分发系统。 它主要通过最大限度地利用网络带宽，提高文件传输的速率和效率，来解决大量数据分发的问题，例如：文件分发、镜像分发等。现在为云原生计算机基金会（CNCF）托管作为孵化级项目。

主要功能特性如下：

- 基于 P2P 的文件分发：通过利用 P2P 技术进行文件传输，它能最大限度地利用每个对等节点（Peer）的带宽资源，以提高下载效率，并节省大量跨机房带宽，尤其是昂贵的跨境带宽。
- 非侵入式支持所有类型的容器技术：Dragonfly 可无缝支持多种容器用于分发镜像。
- 被动式 CDN：这种 CDN 机制可防止重复远程下载。
- 高度一致性：Dragonfly 可确保所有下载的文件是一致的，即使用户不提供任何检查代码（MD5）。
- 磁盘保护和高效 IO：预检磁盘空间、延迟同步、以最佳顺序写文件分块、隔离网络-读/磁盘-写等等。
- 高性能：SuperNode 是完全闭环的，意味着它不依赖任何数据库或分布式缓存，能够以极高性能处理请求。
- 自动隔离异常：Dragonfly 会自动隔离异常节点（对等节点或 SuperNode）来提高下载稳定性。


## Dragonfly 运作流程

Dragonfly 是一种无侵入的解决方案，并不需要修改 Docker 等源码，上图为 Dragonfly 的架构图，在每一个节点上会启动一个 dfdaemon 和 dfget, dfdaemon 是一个代理程序，他会截获 dockerd 上传或者下载镜像的请求， dfget 是一个下载客户端工具。每个 dfget 启动后 将自己注册到 supernode 上。 supernode 超级节点以被动 CDN的方式产生种子数据块，并调度数据块分布。

<div  align="center">
	<img src="../assets/dragonfly.png" width = "550"  align=center />
</div>


通过镜像加速下载的场景，解析其中运作原理：

- dfget-proxy 拦截客户端 docker 发起的镜像下载请求（docker pull）并转换为向 SuperNode 的 dfget 下载请求；
- SuperNode 从镜像源仓库下载镜像并将镜像分割成多个 block 种子数据块；
- dfget 下载数据块并对外共享已下载的数据块，SuperNode 记录数据块下载情况，并指引后续下载请求在结点之间以 P2P 方式进行数据块下载；
- Dokcer daemon 的镜像 pull 机制将最终将镜像文件组成完整的镜像。